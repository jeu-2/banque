<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banque J.E.U. - Interface Client</title>
    <link href="/banque/css/style.css" rel="stylesheet"/>
    <script src="/banque/js/main.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>‚ö° BANQUE J.E.U. ‚ö°</h1>
        <p>JARDIN D'√âCHANGE UNIVERSEL - MONNAIE COMMUNAUTAIRE</p>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard">
        <!-- Tableau de Bord Membre -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üë§</span>
                <h2 class="module-title">Tableau de Bord Membre</h2>
            </div>
            <div class="balance-display">
                <div class="user-name">Chargement...</div>
                <div class="user-status">Chargement du type...</div>
                <div class="balance-amount" id="balanceAmount">0</div>
                <div class="balance-label">Points J.E.U. disponibles</div>
                <div class="member-code">Membre : Chargement...</div>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-number" id="totalExchanges">0</span>
                    <span class="stat-label">√âchanges totaux</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="activePartners">0</span>
                    <span class="stat-label">Partenaires actifs</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="reliabilityScore">0%</span>
                    <span class="stat-label">Score fiabilit√©</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="memberRating">-</span>
                    <span class="stat-label">√âvaluation</span>
                </div>
            </div>
        </div>

        <!-- Nouvelle Offre -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üì¢</span>
                <h2 class="module-title">Nouvelle Offre</h2>
            </div>
            <form id="offerForm">
                <div class="form-group">
                    <label class="form-label">Titre de l'Offre</label>
                    <input type="text" class="form-input" placeholder="Ex: Cours de cuisine italienne" id="offreTitre" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Type de l'Offre</label>
                    <select class="form-select" id="offreType" required>
                        <option value="">S√©lectionner un type...</option>
                        <option value="speciale">Sp√©ciale</option>
                        <option value="saisonniere">Saisonni√®re</option>
                        <option value="ponctuelle">Ponctuelle</option>
                        <option value="continue">Continue</option>
                        <option value="liquidation">Liquidation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie</label>
                    <select class="form-select" id="offreCategorie" required>
                        <option value="">S√©lectionner une cat√©gorie...</option>
                        <option value="hebergement">H√©bergement</option>
                        <option value="evenement">√âv√©nement</option>
                        <option value="produit">Produit</option>
                        <option value="service">Service</option>
                        <option value="don">Don</option>
                        <option value="bonus">Bonus</option>
                        <option value="correctif">Correctif</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Points J.E.U.)</label>
                    <input type="number" class="form-input" placeholder="Ex: 80" id="offrePrixPoints" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" placeholder="D√©crivez votre offre en d√©tail..." id="offreDescription" required></textarea>
                </div>
                <button type="submit" class="btn-primary">Publier l'Offre</button>
            </form>
        </div>

        <!-- Nouvelle Transaction -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üíé</span>
                <h2 class="module-title">Nouvelle Transaction</h2>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label class="form-label">Type d'√©change</label>
                    <select class="form-select" id="transactionType" required>
                        <option value="">S√©lectionner un type...</option>
                        <option value="speciale">Sp√©ciale</option>
                        <option value="saisonniere">Saisonni√®re</option>
                        <option value="ponctuelle">Ponctuelle</option>
                        <option value="continue">Continue</option>
                        <option value="liquidation">Liquidation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">R√©f√©rence de l'Offre</label>
                    <input type="text" class="form-input" placeholder="Ex: OFF-2025-rec0ptPxgXb1KsTfX" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Code du partenaire</label>
                    <input type="text" class="form-input" placeholder="JEU0000001" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Points J.E.U.)</label>
                    <input type="number" class="form-input" placeholder="Ex: 50" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description d√©taill√©e</label>
                    <textarea class="form-textarea" placeholder="D√©crivez pr√©cis√©ment l'√©change..." required></textarea>
                </div>
                <button type="submit" class="btn-primary">Enregistrer Transaction</button>
            </form>
        </div>

        <!-- Place du March√© -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üèÜ</span>
                <h2 class="module-title">Place du March√©</h2>
            </div>
            
            <!-- Section de Recherche -->
            <div class="search-section">
                <input type="text" class="search-input" placeholder="üîç Rechercher une offre, un service, un produit..." id="searchInput">
                <div class="search-filters">
                    <button class="filter-btn active" data-category="services">Services</button>
                    <button class="filter-btn" data-category="produits">Produits</button>
                    <button class="filter-btn" data-category="evenements">√âv√©nements</button>
                </div>
            </div>

            <!-- Offres affich√©es -->
            <div id="offersContainer">
                <div class="marketplace-item" data-category="services">
                    <div class="marketplace-header">
                        <div class="marketplace-title">Cours de yoga priv√©</div>
                        <div class="marketplace-price">80 pts</div>
                    </div>
                    <div class="marketplace-provider">Par Sylvie Martineau</div>
                    <div class="marketplace-description">Disponible ce weekend</div>
                </div>
                <div class="marketplace-item" data-category="services">
                    <div class="marketplace-header">
                        <div class="marketplace-title">R√©paration v√©lo expert</div>
                        <div class="marketplace-price">60 pts</div>
                    </div>
                    <div class="marketplace-provider">Par Pierre Gagnon - Service garantie</div>
                    <div class="marketplace-description">R√©paration compl√®te avec garantie 6 mois</div>
                </div>
            </div>
        </div>

        <!-- Historique des Transactions -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üìä</span>
                <h2 class="module-title">Historique des Transactions</h2>
            </div>
            <div id="transactionHistory">
                <!-- Les transactions seront charg√©es dynamiquement -->
                <div class="transaction-item">
                    <div class="transaction-info">
                        <h4>Chargement des transactions...</h4>
                        <div class="transaction-date">Veuillez patienter</div>
                    </div>
                    <div class="transaction-amount">-</div>
                </div>
            </div>
        </div>

        <!-- Messagerie Communautaire -->
        <div class="module-card fade-in-up">
            <div class="module-header">
                <span class="module-icon">üí¨</span>
                <h2 class="module-title">Messagerie Communautaire</h2>
            </div>
            <div class="message-item">
                <div class="message-header">
                    <div class="message-sender">Pierre L.</div>
                    <div class="message-time">Il y a 2h</div>
                </div>
                <div class="message-content">Salut ! J'ai des l√©gumes frais √† √©changer contre des services de jardinage.</div>
            </div>
            <div class="message-item">
                <div class="message-header">
                    <div class="message-sender">Sylvie M.</div>
                    <div class="message-time">Hier</div>
                </div>
                <div class="message-content">Merci pour le massage ! Transaction parfaite comme toujours üòä</div>
            </div>
            <div class="message-compose">
                <textarea class="form-textarea" placeholder="√âcrire un message √† la communaut√©..." rows="3"></textarea>
                <button class="btn-primary" style="margin-top: 1rem;">Envoyer Message</button>
            </div>
        </div>
    </div>
    <div style="height: 25px;"></div>
    
    <!-- Pied de page -->
    <footer class="custom-footer" style="background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,20,40,0.95));
        border-radius: 20px; margin-top: 3rem; border: 2px solid rgba(255,215,0,0.3); 
        backdrop-filter: blur(20px); padding: 2rem; text-align: center;">
        <div class="footer-content">
            <div class="footer-logo" style="font-size: 1.5rem; font-weight: bold; color: #ffd700;">üåü BANQUE J.E.U.</div>
            <div class="footer-links" style="margin: 1rem 0;">
                <a href="#accueil" style="margin: 0 0.5rem; color: #e8e8e8;">Accueil</a>
                <a href="#fonctionnement" style="margin: 0 0.5rem; color: #e8e8e8;">Comment √ßa marche</a>
                <a href="#avantages" style="margin: 0 0.5rem; color: #e8e8e8;">Avantages</a>
                <a href="#contact" style="margin: 0 0.5rem; color: #e8e8e8;">Contact</a>
                <a href="#" style="margin: 0 0.5rem; color: #e8e8e8;">Conditions</a>
                <a href="#" style="margin: 0 0.5rem; color: #e8e8e8;">Confidentialit√©</a>
            </div>
            <div class="footer-bottom" style="color: #c9c9c9; font-size: 0.9rem;">
                <p>¬© 2025 Banque J.E.U. - Jardin d'√âchange Universel. Tous droits r√©serv√©s.</p>
                <p>Une initiative du Consortium BICFIL-MULTI-PAAS-POEZIES sous l'autorit√© de L√©na May√´l</p>
            </div>
        </div>
    </footer>

    <script>
        // Animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in-up');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.module-card').forEach(el => {
            observer.observe(el);
        });

        // Form submissions
        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmission(e, 'Transaction Enregistr√©e !');
        });

        document.getElementById('offerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleFormSubmission(e, 'Offre Publi√©e !');
        });

        function handleFormSubmission(e, successMessage) {
            const button = e.target.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            button.textContent = 'Traitement en cours...';
            button.style.background = 'linear-gradient(45deg, #ffed4a, #ffd700)';
            
            setTimeout(() => {
                button.textContent = '‚úÖ ' + successMessage;
                setTimeout(() => {
                    button.textContent = originalText;
                }, 3000);
            }, 1500);
        }

        // Fonction pour charger les donn√©es du membre
        async function chargerDonneesMembre() {
            const recordId = localStorage.getItem("recordId");
            const nom = localStorage.getItem("nomMembre");
            const code = localStorage.getItem("codeMembre");

            // Afficher les donn√©es de base d√©j√† disponibles
            if (nom && code) {
                const nameEl = document.querySelector(".user-name");
                const codeEl = document.querySelector(".member-code");
                if (nameEl) nameEl.textContent = nom;
                if (codeEl) codeEl.textContent = "Membre : " + code;
            }

            // Charger les donn√©es compl√®tes depuis l'API si recordId disponible
            if (recordId) {
                try {
                    const response = await fetch(`https://banque-api-jeu.onrender.com/api/membres/${recordId}`);
                    if (response.ok) {
                        const membre = await response.json();
                        
                        // Mettre √† jour le type de membre (champ "Statut")
                        const statusEl = document.querySelector(".user-status");
                        if (statusEl && membre.Statut) {
                            statusEl.textContent = membre.Statut;
                        }

                        // Mettre √† jour le solde de points (champ "Solde")
                        const balanceEl = document.getElementById("balanceAmount");
                        if (balanceEl && membre.Solde !== undefined) {
                            balanceEl.textContent = membre.Solde.toLocaleString();
                        }

                        // Mettre √† jour les gains et d√©penses
                        if (membre.Gains !== undefined) {
                            document.getElementById("totalExchanges").textContent = membre.Gains;
                        }
                        if (membre.D√©penses !== undefined) {
                            document.getElementById("activePartners").textContent = Math.abs(membre.D√©penses);
                        }

                        // Calculer le score de fiabilit√© bas√© sur les transactions
                        const totalTransactions = (membre.Gains || 0) + Math.abs(membre.D√©penses || 0);
                        if (totalTransactions > 0) {
                            const scorefiabilite = Math.min(98, 60 + (totalTransactions * 2));
                            document.getElementById("reliabilityScore").textContent = scorefiabilite + "%";
                        }

                        // √âvaluation bas√©e sur le statut
                        let evaluation = "3‚≠ê";
                        if (membre.Statut === "VIP") evaluation = "5‚≠ê";
                        else if (membre.Statut === "R√©gulier") evaluation = "4‚≠ê";
                        else if (membre.Statut === "Invit√©") evaluation = "3‚≠ê";
                        document.getElementById("memberRating").textContent = evaluation;

                        // Sauvegarder les nouvelles donn√©es dans localStorage
                        if (membre.Statut) {
                            localStorage.setItem("typeMembre", membre.Statut);
                        }
                        if (membre.Solde !== undefined) {
                            localStorage.setItem("soldePoints", membre.Solde.toString());
                        }

                    } else {
                        console.error("Erreur lors du chargement des donn√©es du membre");
                        // Utiliser les donn√©es en cache si disponibles
                        chargerDonneesCache();
                    }
                } catch (error) {
                    console.error("Erreur r√©seau lors du chargement des donn√©es:", error);
                    // Utiliser les donn√©es en cache si disponibles
                    chargerDonneesCache();
                }
            } else {
                // Utiliser les donn√©es en cache si pas de recordId
                chargerDonneesCache();
            }
        }

        // Fonction pour charger les donn√©es en cache
        function chargerDonneesCache() {
            const typeMembre = localStorage.getItem("typeMembre");
            const soldePoints = localStorage.getItem("soldePoints");

            if (typeMembre) {
                const statusEl = document.querySelector(".user-status");
                if (statusEl) statusEl.textContent = typeMembre;
            }

            if (soldePoints) {
                const balanceEl = document.getElementById("balanceAmount");
                if (balanceEl) balanceEl.textContent = parseInt(soldePoints).toLocaleString();
            }
        }

        // Fonction pour charger l'historique des transactions
        async function chargerHistoriqueTransactions() {
            const recordId = localStorage.getItem("recordId");
            if (!recordId) return;

            try {
                const response = await fetch(`https://banque-api-jeu.onrender.com/api/transactions?membre=${recordId}`);
                if (response.ok) {
                    const transactions = await response.json();
                    const historyContainer = document.getElementById("transactionHistory");
                    
                    if (transactions && transactions.length > 0) {
                        historyContainer.innerHTML = '';
                        
                        transactions.slice(0, 5).forEach(transaction => {
                            const transactionEl = document.createElement('div');
                            transactionEl.className = 'transaction-item';
                            
                            const date = new Date(transaction.dateTransaction).toLocaleDateString('fr-FR', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const montant = transaction.montant || 0;
                            const isPositive = montant > 0;
                            
                            transactionEl.innerHTML = `
                                <div class="transaction-info">
                                    <h4>${transaction.description || 'Transaction'}</h4>
                                    <div class="transaction-date">${date}</div>
                                </div>
                                <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                                    ${isPositive ? '+' : ''}${montant} pts
                                </div>
                            `;
                            
                            historyContainer.appendChild(transactionEl);
                        });
                    }
                }
            } catch (error) {
                console.error("Erreur lors du chargement de l'historique:", error);
            }
        }

        // Charger les donn√©es au chargement de la page
        document.addEventListener("DOMContentLoaded", function() {
            chargerDonneesMembre();
            chargerHistoriqueTransactions();
            
            // Cr√©er la barre utilisateur
            const nom = localStorage.getItem("nomMembre");
            const code = localStorage.getItem("codeMembre");

            if (nom && code) {
                const userBar = document.createElement("div");
                userBar.style.position = "fixed";
                userBar.style.top = "0";
                userBar.style.right = "0";
                userBar.style.padding = "0.5rem 1rem";
                userBar.style.background = "#222";
                userBar.style.color = "#ffd700";
                userBar.style.zIndex = "9999";
                userBar.innerHTML = `üë§ Connect√© : <strong>${nom} (${code})</strong> <button id="logoutBtn" style="margin-left: 1rem; padding: 0.25rem 0.5rem;" onclick="deconnexion()" class="btn-outline">D√©connexion</button>`;
                document.body.appendChild(userBar);
            }
        });

        // Fonction de d√©connexion
        function deconnexion() {
            localStorage.clear();
            window.location.href = "/";
        }

        // Soumission du formulaire d'offre
        document.getElementById("offerForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const titre = document.getElementById("offreTitre").value.trim();
            const typeOffre = document.getElementById("offreType").value.trim();
            const categorie = document.getElementById("offreCategorie").value.trim();
            const prixPoints = parseInt(document.getElementById("offrePrixPoints").value.trim());
            const description = document.getElementById("offreDescription").value.trim();

            const membreProposant = localStorage.getItem("recordId");
            const dateCreation = new Date().toISOString().split("T")[0];

            const data = {
                titre,
                membreProposant,
                typeOffre,
                categorie,
                description,
                prixPoints,
                dureeQuantite: "",
                avantages: "",
                dateCreation,
                dateLimite: "",
                lieu: "",
                images: [],
                commentaires: ""
            };

            const button = e.target.querySelector("button[type='submit']");
            const originalText = button.textContent;

            button.textContent = "Publication...";
            button.disabled = true;

            try {
                const response = await fetch("https://banque-api-jeu.onrender.com/api/offres", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    button.textContent = "‚úÖ Offre publi√©e !";
                    e.target.reset();
                    if (typeof chargerOffres === "function") chargerOffres();
                } else {
                    console.error(result);
                    alert("Erreur API : " + (result.message || "Erreur inconnue"));
                    button.textContent = "‚ùå √âchec publication";
                }

            } catch (err) {
                console.error("Erreur r√©seau :", err);
                alert("Erreur r√©seau : " + err.message);
                button.textContent = "‚ùå Erreur r√©seau";
            }

            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 3000);
        });
    </script>
</body>
</html>
